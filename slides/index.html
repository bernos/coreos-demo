<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js - The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/night.css" id="theme">
		<link rel="stylesheet" href="css/custom.css">
		
		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" preserveAspectRatio="xMidYMin" height="160px" viewBox="24.5 41.5 744 223" enable-background="new 24.5 41.5 744 223" xml:space="preserve" style="margin-bottom:30px;">
<defs>
<filter id="black-glow">
<feColorMatrix type="matrix" values="0 0 0 0   0
                                 0 0 0 0   0
                                 0 0 0 0   0
                                 0 0 0 0.5 0"></feColorMatrix>
<feGaussianBlur stdDeviation="3.5" result="coloredBlur"></feGaussianBlur>
<feMerge>
<feMergeNode in="coloredBlur"></feMergeNode>
<feMergeNode in="SourceGraphic"></feMergeNode>
</feMerge>
</filter>
</defs>
<path class="co-p-main-nav-brand-mantle" style="filter:url(#black-glow)" fill="#F1606D" d="M136.168,55.389c-17.283,0-31.941,27.645-37.235,66.069c-0.169,1.236-0.333,2.487-0.478,3.746
          c-0.723,6.047-1.213,12.335-1.458,18.808c-0.117,2.962-0.175,5.956-0.175,8.988c0,3.029,0.058,6.029,0.175,8.985
          c0.245,6.472,0.735,12.764,1.458,18.811c8.104,1.049,16.769,1.761,25.807,2.099c3.907,0.146,7.872,0.233,11.907,0.233
          c4.023,0,8-0.088,11.895-0.233c9.049-0.338,17.708-1.05,25.819-2.099c0.892-0.114,1.77-0.239,2.659-0.368
          c33.754-4.74,57.235-15.232,57.235-27.428C233.776,99.088,190.071,55.389,136.168,55.389z"></path>
<path class="co-p-main-nav-brand-core" style="filter:url(#black-glow)" fill="#FFFFFF" d="M176.541,125.569c-0.979-1.428-2.029-2.796-3.148-4.11c-8.956-10.557-22.297-17.265-37.224-17.265
          c-4.839,0-9.148,7.407-11.907,18.909c-1.096,4.586-1.947,9.819-2.495,15.498c-0.432,4.551-0.665,9.391-0.665,14.399
          s0.233,9.849,0.665,14.396c4.554,0.432,9.387,0.664,14.402,0.664c5.009,0,9.842-0.232,14.396-0.664
          c10.011-0.95,18.653-2.875,24.775-5.411c6.046-2.501,9.624-5.615,9.624-8.985C184.963,142.832,181.858,133.388,176.541,125.569z"></path>
<g class="co-p-main-nav-brand-text-bold">
<path style="filter:url(#black-glow)" fill="#FFF" d="M344.891,100.053c12.585,0,22.816,6.138,29.262,13.062l-10.064,11.326
            c-5.353-5.192-11.175-8.495-19.041-8.495c-16.839,0-28.953,14.16-28.953,37.291c0,23.448,11.169,37.608,28.32,37.608
            c9.128,0,15.895-3.775,21.717-10.228l10.067,11.169c-8.335,9.598-19.038,14.95-32.099,14.95c-26.119,0-46.731-18.88-46.731-53.025
            C297.37,120.036,318.454,100.053,344.891,100.053z"></path>
<path style="filter:url(#black-glow)" fill="#FFF" d="M416.961,125.701c19.352,0,36.822,14.793,36.822,40.597c0,25.647-17.471,40.439-36.822,40.439
            c-19.197,0-36.66-14.792-36.66-40.439C380.301,140.494,397.764,125.701,416.961,125.701z M416.961,191.945
            c11.33,0,18.25-10.228,18.25-25.647c0-15.577-6.92-25.804-18.25-25.804s-18.094,10.227-18.094,25.804
            C398.867,181.717,405.631,191.945,416.961,191.945z"></path>
<path style="filter:url(#black-glow)" fill="#FFF" d="M459.771,127.589h14.943l1.26,13.688h0.629c5.506-10.07,13.691-15.577,21.871-15.577
            c3.938,0,6.455,0.472,8.811,1.574l-3.148,15.734c-2.67-0.784-4.717-1.257-8.018-1.257c-6.139,0-13.539,4.245-18.256,15.893v47.203
            h-18.092L459.771,127.589L459.771,127.589z"></path>
<path style="filter:url(#black-glow)" fill="#FFF" d="M541.121,125.701c20.928,0,31.941,15.107,31.941,36.667c0,3.458-0.314,6.604-0.787,8.495h-49.09
            c1.57,14.003,10.379,21.869,22.811,21.869c6.613,0,12.273-2.041,17.941-5.662l6.135,11.326c-7.395,4.878-16.676,8.341-26.432,8.341
            c-21.404,0-38.08-14.95-38.08-40.439C505.561,141.12,523.023,125.701,541.121,125.701z M557.326,159.376
            c0-12.277-5.189-19.671-15.732-19.671c-9.125,0-16.996,6.768-18.57,19.671H557.326z"></path>
</g>
<path class="co-p-main-nav-brand-text-light" style="filter:url(#black-glow)" fill="#F1606D" d="M600.602,152.607c0-32.729,17.785-53.344,42.799-53.344c24.863,0,42.641,20.615,42.641,53.344
          c0,32.889-17.777,54.13-42.641,54.13C618.387,206.737,600.602,185.496,600.602,152.607z M678.49,152.607
          c0-28.639-14.158-46.731-35.09-46.731c-21.084,0-35.248,18.093-35.248,46.731c0,28.796,14.164,47.521,35.248,47.521
          C664.332,200.128,678.49,181.403,678.49,152.607z"></path>
<path class="co-p-main-nav-brand-text-light" style="filter:url(#black-glow)" fill="#53A4D9" d="M699.738,186.125c7.557,8.495,18.412,14.003,30.529,14.003c15.732,0,25.807-8.499,25.807-20.767
          c0-12.904-8.494-17.154-18.723-21.717l-15.736-7.082c-8.969-3.936-20.934-10.385-20.934-25.808
          c0-14.947,12.904-25.492,30.059-25.492c12.588,0,22.658,5.665,28.949,12.435l-4.244,4.878c-5.982-6.452-14.32-10.7-24.705-10.7
          c-13.691,0-22.816,7.239-22.816,18.565c0,11.962,10.385,16.521,17.936,19.985l15.738,6.921
          c11.486,5.195,21.713,11.647,21.713,27.539s-13.061,27.851-33.201,27.851c-15.107,0-26.75-6.451-34.932-15.576L699.738,186.125z"></path>
<path class="co-p-main-nav-brand-crust" style="filter:url(#black-glow)" fill="#53A3DA" d="M136.168,45.527C76.898,45.527,28.689,93.739,28.689,153c0,59.265,48.209,107.474,107.479,107.474
          c59.252,0,107.465-48.209,107.465-107.474C243.633,93.739,195.42,45.527,136.168,45.527z M176.542,180.428
          c-0.889,0.129-1.767,0.254-2.659,0.368c-8.111,1.049-16.77,1.761-25.819,2.099c-3.895,0.145-7.872,0.233-11.895,0.233
          c-4.035,0-8-0.087-11.907-0.233c-9.038-0.338-17.703-1.05-25.807-2.099c-0.723-6.047-1.213-12.339-1.458-18.811
          c-0.117-2.956-0.175-5.956-0.175-8.985c0-3.032,0.058-6.026,0.175-8.988c0.245-6.473,0.735-12.761,1.458-18.808
          c0.145-1.259,0.309-2.51,0.478-3.746c5.294-38.424,19.952-66.069,37.235-66.069c53.903,0,97.608,43.699,97.609,97.611
          C233.777,165.196,210.296,175.688,176.542,180.428z"></path>
</svg>
					
					<h3>Managing Docker containers</h3>
					<p>
						<small><a href="http://blog.brendan-mcmahon.com">Brendan McMahon</a> / <a href="http://twitter.com/bernos">@bernos</a></small>
					</p>
				</section>

				<section>
					<h2>Overview</h2>
					<ul>
						<li>Introduction to coreos+docker</li>
						<li>Service discovery with etcd</li>
						<li>Container and cluster management with systemd+fleetctl</li>
						<li>Builing a simple load balanced web application with service discovery</li>
					</ul>
				</section>

				<section>
					<h2>Coreos</h2>
					<ul>
						<li>Linux for "Massive Server Deployments"</li>
						<li>Docker as first class concern. No package manager. All applications containerised by default</li>
						<li>Basic building blocks - etcd distributed kv store and systemd init system</li>
						<li>Runs on almost any platform, including <a href="https://coreos.com/docs/vagrant/">Vagrant</a>, <a href="https://coreos.com/docs/ec2/">Amazon EC2</a>, <a href="https://coreos.com/docs/qemu/">QEMU/KVM</a>, <a href="https://coreos.com/docs/vmware/">VMware</a> and <a href="https://coreos.com/docs/openstack/">OpenStack</a> and your <a href="https://coreos.com/products">own hardware</a></li>
					</ul>
				</section>

				<section>
					<h2>etcd</h2>
					<ul>
						<li>Distributed kv store</li>
						<li>Interface via cli or http</li>
						<li>Used for congiruation management and service discovery</li>
						<li>Easily accessible from within containers via <code>docker0</code> interface</li>
					</ul>
					<p>
						<img class="no-border" src="/img/etcd.svg"/>
					</p>
				</section>
				<section>
					<h2>Simple etcd example</h2>
					<p>Setting simple values</p>
					<pre><code data-trim contenteditable class="bash">
etcdctl set /foo-service/container2 localhost:2222
etcdctl get /foo-service/container2
etcdctl rm /foo-service/container2
					</code></pre>
					<p>Watch for changes</p>
					<pre><code data-trim contenteditable class="bash">
etcdctl watch /foo-service --recursive
					</code></pre>
				</section>

				<section>
					<h2>systemd + fleet</h2>
					<div style="text-align:left;">
					<p>
						<h4>systemd</h4>
						<ul>
							<li>Init system - starts, stops, manages processes</li>
							<li>Units - files that describe processes you'd like to run</li>
						</ul>
						</p>
						<p>
						<h4>fleet</h4>
						<ul>
							<li>Controls systemd across a cluster</li>
							<li>Adds semantics to systemd units for service dependency and distribution</li>
							<li>Used to deploy, stop, start and manage units and containers in the cluster</li>
						</ul>
						</p>
					</div>

				</section>

				<section>
					<h2>A Hello World Service</h2>
					<pre><code data-trim contenteditable class="ini stretch">
[Unit]
Description=A very annonying service

# Requirements
Requires=docker.service

# Dependency ordering and binding
After=docker.service

[Service]
# Let processes take as long as it needs to start up
TimeoutStartSec=0

# Pre startup
# Directives with "=-" are allowed to fail without consequence
ExecStartPre=-/usr/bin/docker kill busybox1
ExecStartPre=-/usr/bin/docker rm busybox1
ExecStartPre=/usr/bin/docker pull busybox

# Startup
ExecStart=/usr/bin/docker run --name busybox1 busybox /bin/sh -c "\
  while true; do \
    echo Hello there World; \
    sleep 1; \
  done"

# Stop
ExecStop=/usr/bin/docker stop busybox1
					</code></pre>
					<aside class="notes">
						<pre>
fleetctl start hello-world.service 
fleetctl list-units
fleetctl journal hello-world.service
fleetctl stop hello-world.service 
fleetctl destroy hello-world.service</pre>
					</aside>
				</section>

				<section>
				
					<h3>A simple load balanced web app</h3>
					<img src="/img/arch.svg" class="no-border" style="max-height:512px; height:100%;" />
					
				</section>

				<section>
					<h2>apache@.service</h2>
					<p>Apache web server unit template</p>
					<pre><code data-trim contenteditable class="ini">
[Unit]
Description=Apache web server service on port %i

# Requirements
Requires=etcd.service
Requires=docker.service
Requires=apache-discovery@%i.service

# Dependency ordering
After=etcd.service
After=docker.service
Before=apache-discovery@%i.service

[Service]
# Let processes take awhile to start up (for first run Docker containers)
TimeoutStartSec=0

# Change killmode from "control-group" to "none" to let Docker remove
# work correctly.
KillMode=none

# Get CoreOS environmental variables
EnvironmentFile=/etc/environment

# Pre-start and Start
## Directives with "=-" are allowed to fail without consequence
ExecStartPre=-/usr/bin/docker kill apache.%i
ExecStartPre=-/usr/bin/docker rm apache.%i
ExecStartPre=/usr/bin/docker pull coreos/apache
ExecStart=/usr/bin/docker run --name apache.%i -p ${COREOS_PRIVATE_IPV4}:%i:80 coreos/apache /usr/sbin/apache2ctl -D FOREGROUND

# Stop
ExecStop=/usr/bin/docker stop apache.%i

[X-Fleet]
# Don't schedule on the same machine as other Apache instances
Conflicts=apache@*.service						

					</code></pre>
					<aside class="notes">
						Explain unit templates here. Discuss use of %i
						<pre>
fleetctl submit apache@.service
fleetctl start apache@7777
fleetctl start apache@8888</pre>
					</aside>
				</section>

				<section>
					<h2>apache-discovery@.service</h2>
					<p>Apache discovery sidekick unit template</p>
					<pre><code data-trim contenteditable class="ini">
[Unit]
Description=Apache web server on port %i etcd registration

# Requirements
Requires=etcd.service
Requires=apache@%i.service

# Dependency ordering and binding
After=etcd.service
After=apache@%i.service
BindsTo=apache@%i.service

[Service]
# Get CoreOS environmental variables
EnvironmentFile=/etc/environment

# Start
## Test whether service is accessible and then register useful information
ExecStart=/bin/bash -c '\
  while true; do \
    curl -f ${COREOS_PRIVATE_IPV4}:%i; \
    if [ $? -eq 0 ]; then \
      etcdctl set /services/apache/${COREOS_PRIVATE_IPV4} \'${COREOS_PRIVATE_IPV4}:%i\' --ttl 30; \
    else \
      etcdctl rm /services/apache/${COREOS_PRIVATE_IPV4}; \
    fi; \
    sleep 20; \
  done'

# Stop
ExecStop=/usr/bin/etcdctl rm /services/apache/${COREOS_PRIVATE_IPV4}

[X-Fleet]
# Schedule on the same machine as the associated Apache service
MachineOf=apache@%i.service						
					</code></pre>
					<aside class="notes">
						<pre>
fleetctl submit apache-discovery@.service
fleetctl start apache-discovery@7777
fleetctl start apache-discovery@8888
fleetctl list-units</pre>
SSH into core-01
<pre>
etcdctl ls /services/ --recursive
etcdctl get /services/apache/172.17.8.101</pre>
					</aside>
				</section>

				<section>
					<section>
						<h2>Nginx load balancer container</h2>
						<ul>
							<li>Monitor for changes to etcd apacher service keys and update backend config</li>
							<li>Uses confd for managing config updates <a href="https://github.com/kelseyhightower/confd">https://github.com/kelseyhightower/confd</a></li>
						</ul>
					</section>
					
					<section>
						<h2>Confd template</h2>
						<pre><code data-trim contenteditable class="ini stretch">
[template]
# /etc/confd/conf.d/nginx.toml

# The name of the template that will be used to render the application's configuration file
# Confd will look in `/etc/conf.d/templates` for these files by default
src = "nginx.tmpl"

# The location to place the rendered configuration file
dest = "/etc/nginx/sites-enabled/app.conf"

# The etcd keys or directory to watch.  This is where the information to fill in
# the template will come from.
keys = [ "/services/apache" ]

# File ownership and mode information
owner = "root"
mode = "0644"

# These are the commands that will be used to check whether the rendered config is
# valid and to reload the actual service once the new config is in place
check_cmd = "/usr/sbin/nginx -t"
reload_cmd = "/usr/sbin/service nginx reload"
						</code></pre>
					</section>

					<section>
						<h2>Nginx config template</h2>
						<pre><code data-trim contenteditable class="ini stretch">
# /etc/confd/templates/nginx.tmpl

upstream apache_pool {
{{ range getvs "/services/apache/*" }}
    server {{ . }};
{{ end }}
}

server {
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;

    access_log /var/log/nginx/access.log upstreamlog;

    location / {
        proxy_pass http://apache_pool;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
						</code></pre>
					</section>

					<section>
						<h2>Confd startup script</h2>
						<pre><code data-trim contenteditable class="ini stretch">
#!/bin/bash

# /usr/local/bin/confd-watch

set -eo pipefail

export ETCD_PORT=${ETCD_PORT:-4001}
export HOST_IP=${HOST_IP:-172.17.42.1}
export ETCD=$HOST_IP:$ETCD_PORT

echo "[nginx] booting container. ETCD: $ETCD."

# Try to make initial configuration every 5 seconds until successful
until confd -onetime -node $ETCD -config-file /etc/confd/conf.d/nginx.toml; do
    echo "[nginx] waiting for confd to create initial nginx configuration."
    sleep 5
done

# Put a continual polling `confd` process into the background to watch
# for changes every 10 seconds
confd -interval 10 -node $ETCD -config-file /etc/confd/conf.d/nginx.toml &
echo "[nginx] confd is now monitoring etcd for changes..."

# Start the Nginx service using the generated config
echo "[nginx] starting nginx service..."
service nginx start

# Follow the logs to allow the script to continue running
tail -f /var/log/nginx/*.log
						</code></pre>
					</section>
				</section>

				<section>
					<h2>Nginx load balancer service</h2>
					<pre><code data-trim contenteditable class="ini">
[Unit]
Description=Nginx load balancer for web server backends

# Requirements
Requires=etcd.service
Requires=docker.service

# Dependency ordering
After=etcd.service
After=docker.service

[Service]
# Let the process take awhile to start up (for first run Docker containers)
TimeoutStartSec=0

# Change killmode from "control-group" to "none" to let Docker remove
# work correctly.
KillMode=none

# Get CoreOS environmental variables
EnvironmentFile=/etc/environment

# Pre-start and Start
## Directives with "=-" are allowed to fail without consequence
ExecStartPre=-/usr/bin/docker kill nginx_lb
ExecStartPre=-/usr/bin/docker rm nginx_lb
ExecStartPre=/usr/bin/docker pull bernos/nginx_lb
ExecStart=/usr/bin/docker run --name nginx_lb -p ${COREOS_PUBLIC_IPV4}:80:80 bernos/nginx_lb /usr/local/bin/confd-watch

# Stop
ExecStop=/usr/bin/docker stop nginx_lb

[X-Fleet]
Conflicts=nginx_lb.service
Conflicts=apache@*.service
					</code></pre>
					<aside class="notes">
						<pre>
fleetctl start nginx_lb</pre>
					</aside>
				</section>



			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
